```{r}

# meta analysis workflow ------
meta_analysis_workflow <- function(data, 
                                   effect_size_label, 
                                   reference_line, 
                                   exp_estimates = FALSE,
                                   plot = TRUE,
                                   at = NULL) {
  require(timesavers)
  require(tidyverse)
  require(metafor)
  
  # fit random effects model 
  fitted_model <- 
    rma(yi = yi, 
        sei = sei,
        data = data,
        slab = Experiment)
  
  p_value <- apa_p_value(fitted_model$pval)
  
  # model predictions
  meta_analysis_results <-
    predict(fitted_model, digits = 5) %>%
    as.data.frame() %>%
    gather() %>%
    round_df(2) %>%
    dplyr::rename(metric = key,
                  estimate = value) %>%
    mutate(metric = dplyr::recode(metric,
                                  "pred" = paste0("Meta analysed ", effect_size_label),
                                  "ci.lb" = "95% CI lower",
                                  "ci.ub" = "95% CI upper",
                                  "cr.lb" = "95% CR lower",
                                  "cr.ub" = "95% CR upper"))
  
  # Color_Matchingally exponentiate estimates if converting log odds to odds ratios
  if(exp_estimates == TRUE) {
    meta_analysis_results <- meta_analysis_results %>%
      mutate(estimate = round(exp(estimate), 2))
  }
  
  meta_analysis_results <- rbind(meta_analysis_results,
                                 data.frame(metric = "p",
                                            estimate = p_value))
  
  # summarize results
  meta_analysis_results_text <- 
    paste0("k = ", fitted_model$k, ", ", 
           effect_size_label, " = ", meta_analysis_results$estimate[1],
           # dynamic indexing of some values as different models return variables in different locations, but relative location is reliable
           ", 95% CI = [", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-4],  
           ", ", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-3], 
           "], 95% CR = [", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-2], 
           ", ", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-1],
           "], p ", meta_analysis_results$estimate[length(meta_analysis_results$estimate)])
  
  heterogeneity_test_results_text <- 
    paste0("Q(df = ",    fitted_model$k - 1, ") = ", round(fitted_model$QE, 2), 
           ", p = ",     ifelse(fitted_model$pval < 0.001, "< .001", as.character(round(fitted_model$pval, 3))),
           ", tau^2 = ", round(fitted_model$tau2, 2), 
           ", I^2 = ",   round(fitted_model$I2, 2),
           ", H^2 = ",   round(fitted_model$H2, 2))
  
  # forest plot
  if (exp_estimates == TRUE) {
    transformation <- exp
  } else { 
    transformation <- NULL
  }
  
  
  if (plot == TRUE) {
    if(is.null(at)) {
      forest_plot <- forest(fitted_model,
                            xlab = effect_size_label,
                            addcred = TRUE,
                            atransf = transformation,
                            refline = reference_line)
    } else if (!is.null(at)) {
      forest_plot <- forest(fitted_model,
                            xlab = effect_size_label,
                            addcred = TRUE,
                            atransf = transformation,
                            refline = reference_line, 
                            at = at)
    }
  } else {
    forest_plot <- NULL
  }
  
  
  return(list(fitted_model = fitted_model, 
              meta_analysis_results = meta_analysis_results,
              meta_analysis_results_text = meta_analysis_results_text,
              heterogeneity_test_results_text = heterogeneity_test_results_text,
              forest_plot = forest_plot))
}


# get data
# experiments were run (and are recorded in data) as 1,2,3,4,5. However, they are reported in the manuscript as 1,2,3,5,4. 
# relabel the studies to follow the latter order for reporting in the manuscript
results_for_meta_analysis_h1_sensitivity <- read.csv("../meta analysis data/results_for_meta_analysis_iat.csv") %>%
  filter(Experiment != "Experiment 2") %>%
  mutate(Experiment = dplyr::recode(Experiment, 
                                    `Experiment 1` = "Experiment 1",
                                    `Experiment 3` = "Experiment 3",
                                    `Experiment 4` = "Experiment 5",
                                    `Experiment 5` = "Experiment 4"),
         Experiment = fct_relevel(Experiment, 
                                  "Experiment 1",
                                  "Experiment 3",
                                  "Experiment 4",
                                  "Experiment 5")) %>%
  arrange(Experiment)

results_for_meta_analysis_h2_sensitivity <- read.csv("../meta analysis data/results_for_meta_analysis_self_report.csv") %>%
  filter(Experiment != "Experiment 2") %>%
  mutate(Experiment = dplyr::recode(Experiment, 
                                    `Experiment 1` = "Experiment 1",
                                    `Experiment 3` = "Experiment 3",
                                    `Experiment 4` = "Experiment 5",
                                    `Experiment 5` = "Experiment 4"),
         Experiment = fct_relevel(Experiment, 
                                  "Experiment 1",
                                  "Experiment 3",
                                  "Experiment 4",
                                  "Experiment 5")) %>%
  arrange(Experiment)

results_for_meta_analysis_h3_sensitivity <- read.csv("../meta analysis data/results_for_meta_analysis_behavioural_intentions.csv") %>%
  filter(Experiment != "Experiment 2") %>%
  mutate(Experiment = dplyr::recode(Experiment, 
                                    `Experiment 1` = "Experiment 1",
                                    `Experiment 3` = "Experiment 3",
                                    `Experiment 4` = "Experiment 5",
                                    `Experiment 5` = "Experiment 4"),
         Experiment = fct_relevel(Experiment, 
                                  "Experiment 1",
                                  "Experiment 3",
                                  "Experiment 4",
                                  "Experiment 5")) %>%
  arrange(Experiment)

# plot
meta_results_h1_sensitivity <- 
  meta_analysis_workflow(data              = results_for_meta_analysis_h1_sensitivity,
                         effect_size_label = "Cohen's d",
                         exp_estimates     = FALSE,
                         reference_line    = 0)

meta_results_h2_sensitivity <- 
  meta_analysis_workflow(data              = results_for_meta_analysis_h2_sensitivity,
                         effect_size_label = "Cohen's d",
                         exp_estimates     = FALSE,
                         reference_line    = 0)

meta_results_h3_sensitivity <- 
  meta_analysis_workflow(data              = results_for_meta_analysis_h3_sensitivity,
                         effect_size_label = "Odds Ratio",
                         exp_estimates     = TRUE,
                         reference_line    = 0, # on log odds scale
                         at = c(log(1), log(3), log(10), log(30), log(100)))

```