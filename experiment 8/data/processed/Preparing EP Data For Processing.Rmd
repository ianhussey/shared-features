---
title: "Preparing_EP_Data"
author: "Sean Hughes"
date: "30-7-2019"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```


# Load the necessary packages

```{r}
library(foreign)
library(tidyverse)
library(Hmisc)
library(car)
library(readxl)
```

## 1. Read in and combine EPT data files

```{r}
File_Raw_Data_1 <- read_excel("study_8_ep_task_after_19_08_02.xlsx")
File_Raw_Data_2 <- read_excel("study_8_ep_task_before_19_08_02.xlsx")
File_Raw_Data <- rbind(File_Raw_Data_1,File_Raw_Data_2)

unique(File_Raw_Data$subject) # so 494 pps !

```

## 2. Prepare EP Data file for processing

```{r}

# Retain only the needed columns 
# Arrange by Practice Block so I can easily remove these trials
# Remove trials from Practice Block

File_Working_Data <- select(.data = File_Raw_Data, 
                            subject, blocknum, trialnum, blockcode, trialcode, correct, latency) %>%
  
  arrange(desc(blockcode)) %>%   
  
  filter(blockcode != "Evaluative_Priming_Task_.practice.block") 

```

## 3. Exclude participants with incomplete EP data (i.e., less than 80 trials)

```{r}

# Retain the subject and trialnumber columns from the Working Data file

Complete_Data_Check_Step_1 <- select(File_Working_Data,
                                     subject, trialnum) 

# Create two lists based on the subject and total number of trials 

Complete_Data_Check_Step_2 <- rle(sort(Complete_Data_Check_Step_1$subject))

# Report the number of trials per participant

Complete_Data_Check_Step_3 <- data.frame(number=Complete_Data_Check_Step_2$values, n=Complete_Data_Check_Step_2$lengths)

# Indicate how many participants who have more or less trials than desired (in this case 80)

Complete_Data_Check_Step_4 <- Complete_Data_Check_Step_3[Complete_Data_Check_Step_3$n<80|Complete_Data_Check_Step_3$n>80,]

# participants with missing data

Complete_Data_Check_Step_4 

# Remove these individuals from the File_Working_Data file

File_Working_Data <- File_Working_Data[!(File_Working_Data$subject %in% Complete_Data_Check_Step_4$number),]

Complete_Data_Check_Step_5  <- rle(sort(File_Working_Data$subject))
Complete_Data_Check_Final <- data.frame(number=Complete_Data_Check_Step_5$values, n=Complete_Data_Check_Step_5$lengths)

# 493 retained participants
describe(Complete_Data_Check_Final) 

```

## 4. Removing Error Trials

```{r}

describe(File_Working_Data$correct)

File_Working_Data <- filter(.data = File_Working_Data,
                            correct == 1)

describe(File_Working_Data$correct) 

# start with 39440 and end with 37761: 4.26% of total trials removed because of errors

```

## 5. Remove Trials with Excessive Latencies

```{r}

describe(File_Working_Data$latency)


File_Working_Data <- filter(.data = File_Working_Data,
                            latency > 299)

File_Working_Data <- filter(.data = File_Working_Data,
                            latency < 1001)

describe(File_Working_Data$latency) 

#Started with 37761 and end with 35524: 9.69% of error-free trials removed

```


## 6. Create four different trial-types from Evaluative Priming Data 

```{r}
# Four trial-types: (1) Morag - Good (2) Morag - Bad (3) Struan - Good (4) Struan - Bad

File_Working_Data <- mutate(File_Working_Data, 
                            Trial_Type = dplyr::recode(File_Working_Data$trialcode, 
                                                       Morag_Negative_Trial_1 = "Morag_Negative",
                                                       Morag_Negative_Trial_2 = "Morag_Negative",
                                                       Morag_Negative_Trial_3 = "Morag_Negative",
                                                       Morag_Negative_Trial_4 = "Morag_Negative",
                                                       Morag_Negative_Trial_5 = "Morag_Negative",
                                                       Morag_Negative_Trial_6 = "Morag_Negative",
                                                       Morag_Negative_Trial_7 = "Morag_Negative",
                                                       Morag_Negative_Trial_8 = "Morag_Negative",
                                                       Morag_Negative_Trial_9 = "Morag_Negative",
                                                       Morag_Negative_Trial_10 = "Morag_Negative",
                                                       Morag_Positive_Trial_1 = "Morag_Positive",
                                                       Morag_Positive_Trial_2 = "Morag_Positive",
                                                       Morag_Positive_Trial_3 = "Morag_Positive",
                                                       Morag_Positive_Trial_4 = "Morag_Positive",
                                                       Morag_Positive_Trial_5 = "Morag_Positive",
                                                       Morag_Positive_Trial_6 = "Morag_Positive",
                                                       Morag_Positive_Trial_7 = "Morag_Positive",
                                                       Morag_Positive_Trial_8 = "Morag_Positive",
                                                       Morag_Positive_Trial_9 = "Morag_Positive",
                                                       Morag_Positive_Trial_10 = "Morag_Positive",
                                                       Struan_Positive_Trial_1 = "Struan_Positive",
                                                       Struan_Positive_Trial_2 = "Struan_Positive",
                                                       Struan_Positive_Trial_3 = "Struan_Positive",
                                                       Struan_Positive_Trial_4 = "Struan_Positive",
                                                       Struan_Positive_Trial_5 = "Struan_Positive",
                                                       Struan_Positive_Trial_6 = "Struan_Positive",
                                                       Struan_Positive_Trial_7 = "Struan_Positive",
                                                       Struan_Positive_Trial_8 = "Struan_Positive",
                                                       Struan_Positive_Trial_9 = "Struan_Positive",
                                                       Struan_Positive_Trial_10 = "Struan_Positive",
                                                       Struan_Negative_Trial_1 = "Struan_Negative",
                                                       Struan_Negative_Trial_2 = "Struan_Negative",
                                                       Struan_Negative_Trial_3 = "Struan_Negative",
                                                       Struan_Negative_Trial_4 = "Struan_Negative",
                                                       Struan_Negative_Trial_5 = "Struan_Negative",
                                                       Struan_Negative_Trial_6 = "Struan_Negative",
                                                       Struan_Negative_Trial_7 = "Struan_Negative",
                                                       Struan_Negative_Trial_8 = "Struan_Negative",
                                                       Struan_Negative_Trial_9 = "Struan_Negative",
                                                       Struan_Negative_Trial_10 = "Struan_Negative"))
```

## 7. Calculate EP scores for MORAG and Struan separately and then calculate a final EP score

```{r}

File_EP_Scores <- File_Working_Data %>%
  group_by(subject, Trial_Type) %>%                               
  summarise(score = mean(latency)) %>%
  ungroup() %>%
  spread(key = Trial_Type, value = score) %>%
  mutate(Morag_EP_Score = Morag_Positive - Morag_Negative,
         Struan_EP_Score = Struan_Positive - Struan_Negative,
         Overall_EP_Score = Morag_EP_Score - Struan_EP_Score)   

```

## 8. Write to Excel File 

```{r}
write_csv(File_EP_Scores, path = "Evaluative_Priming_Data.csv")
```


